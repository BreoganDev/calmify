// Calmify - PWA de Podcasts, Meditaciones y reconexión
generator client {
    provider = "prisma-client-js"
    binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
    provider = "sqlite"
    url      = env("DATABASE_URL")
}

// NextAuth.js Models
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  password      String?   // Para autenticación con credentials
  role          Role      @default(USER)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  accounts Account[]
  sessions Session[]
  favorites Favorite[]
  listens   Listen[]
  playlists Playlist[]
  comments  Comment[]
  events    TrackingEvent[]
  deals     Deal[]         @relation("DealOwner")
  contact   Contact?       @relation("UserContact")
  interactions Interaction[] @relation("InteractionAuthor")
  emailEvents EmailEvent[]
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// Modelos principales de Calmify
enum Role {
  USER
  ADMIN
  COLLABORATOR
}

enum CategoryType {
  PODCAST
  MEDITATION
  HYPNOSIS
}

enum TrackingEventType {
  SIGNUP
  EMAIL_VERIFIED
  PLAY
  FAVORITE_ADDED
  FAVORITE_REMOVED
  LOGIN
  COMMENT_CREATED
  PLAYLIST_CREATED
  EMAIL_OPENED
}

enum CampaignStatus {
  DRAFT
  SENT
}

enum PipelineStage {
  LEAD
  ACTIVE
  RISK
  CHURN
}

enum InteractionType {
  NOTE
  CALL
  EMAIL
}

model Automation {
  id            String             @id @default(cuid())
  name          String
  trigger       TrackingEventType
  delayMinutes  Int                @default(0)
  subject       String
  body          String
  active        Boolean            @default(true)
  templateId    String?
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt

  scheduledRuns ScheduledAutomation[]
  template      EmailTemplate?     @relation(fields: [templateId], references: [id])
}

model ScheduledAutomation {
  id            String       @id @default(cuid())
  automationId  String
  contactId     String
  toEmail       String
  subject       String
  body          String
  dueAt         DateTime
  sentAt        DateTime?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  automation Automation @relation(fields: [automationId], references: [id], onDelete: Cascade)
  contact    Contact    @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@index([dueAt])
  @@index([sentAt])
}

model Category {
  id          String       @id @default(cuid())
  name        String       @unique
  description String?
  type        CategoryType
  color       String?      // Color hex para la UI
  icon        String?      // Icono de lucide-react
  canDelete   Boolean      @default(true) // Permite eliminar la categoría
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  audios Audio[]
}

model Audio {
  id          String   @id @default(cuid())
  title       String
  description String?
  duration    Int?     // Duración en segundos
  fileUrl     String   // URL del archivo de audio
  fileSize    Int?     // Tamaño del archivo en bytes
  coverId     String?  // ID de la carátula
  categoryId  String
  author      String?  // Autor/Creador del contenido
  isPublished Boolean  @default(false)
  listens     Int      @default(0) // Contador de reproducciones
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  category      Category       @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  cover         Cover?         @relation(fields: [coverId], references: [id])
  favorites     Favorite[]
  listenHistory Listen[]
  comments      Comment[]
  playlistItems PlaylistItem[]
  events        TrackingEvent[]

  @@index([categoryId])
  @@index([isPublished])
}

model Cover {
  id        String   @id @default(cuid())
  filename  String
  originalName String
  mimeType  String
  size      Int      // Tamaño en bytes
  width     Int?
  height    Int?
  url       String   // URL de la imagen
  createdAt DateTime @default(now())

  audios Audio[]
}

// Modelos para interacciones del usuario
model Favorite {
  id      String @id @default(cuid())
  userId  String
  audioId String
  createdAt DateTime @default(now())

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  audio Audio @relation(fields: [audioId], references: [id], onDelete: Cascade)

  @@unique([userId, audioId])
}

model Listen {
  id        String   @id @default(cuid())
  userId    String
  audioId   String
  progress  Int      @default(0) // Progreso en segundos
  completed Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  audio Audio @relation(fields: [audioId], references: [id], onDelete: Cascade)

  @@unique([userId, audioId])
}

// Modelos para playlists personalizadas
model Playlist {
  id          String         @id @default(cuid())
  name        String
  description String?
  userId      String
  isPublic    Boolean        @default(false)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  user  User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  items PlaylistItem[]

  @@index([userId])
}

model PlaylistItem {
  id         String   @id @default(cuid())
  playlistId String
  audioId    String
  order      Int      @default(0)
  createdAt  DateTime @default(now())

  playlist Playlist @relation(fields: [playlistId], references: [id], onDelete: Cascade)
  audio    Audio    @relation(fields: [audioId], references: [id], onDelete: Cascade)

  @@unique([playlistId, audioId])
  @@index([playlistId])
}

// Modelo para comentarios
model Comment {
  id        String   @id @default(cuid())
  content   String
  userId    String
  audioId   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  audio Audio @relation(fields: [audioId], references: [id], onDelete: Cascade)

  @@index([audioId])
  @@index([userId])
}

model TrackingEvent {
  id        String            @id @default(cuid())
  userId    String?
  contactId String?
  audioId   String?
  type      TrackingEventType
  metadata  Json?
  createdAt DateTime          @default(now())

  user    User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  contact Contact? @relation(fields: [contactId], references: [id], onDelete: Cascade)
  audio   Audio?   @relation(fields: [audioId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([contactId])
  @@index([audioId])
  @@index([type])
}

model Campaign {
  id          String          @id @default(cuid())
  name        String
  subject     String
  body        String
  status      CampaignStatus  @default(DRAFT)
  recipients  Int             @default(0)
  templateId  String?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  emailEvents EmailEvent[]
  template    EmailTemplate?  @relation(fields: [templateId], references: [id])
}

model Contact {
  id            String        @id @default(cuid())
  userId        String?       @unique
  email         String        @unique
  name          String?
  phone         String?
  role          String?
  lastActivity  DateTime?
  favoriteCategory String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  user          User?         @relation("UserContact", fields: [userId], references: [id], onDelete: Cascade)
  tags          ContactTag[]
  deals         Deal[]
  interactions  Interaction[]
  events        TrackingEvent[]
  scheduledRuns ScheduledAutomation[]
  emailEvents   EmailEvent[]
  sequenceEnrollments SequenceEnrollment[]

  @@index([userId])
}

model Tag {
  id          String       @id @default(cuid())
  name        String       @unique
  description String?
  color       String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  contacts    ContactTag[]
}

model ContactTag {
  id         String   @id @default(cuid())
  contactId  String
  tagId      String

  contact Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)
  tag     Tag     @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([contactId, tagId])
  @@index([tagId])
}

model Deal {
  id          String         @id @default(cuid())
  contactId   String
  ownerUserId String?
  title       String
  value       Int?
  stage       PipelineStage  @default(LEAD)
  notes       String?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  contact Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)
  owner   User?   @relation("DealOwner", fields: [ownerUserId], references: [id], onDelete: Cascade)
}

model Interaction {
  id          String           @id @default(cuid())
  contactId   String
  authorId    String?
  type        InteractionType  @default(NOTE)
  content     String
  metadata    Json?
  createdAt   DateTime         @default(now())

  contact Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)
  author  User?   @relation("InteractionAuthor", fields: [authorId], references: [id], onDelete: Cascade)

  @@index([contactId])
}

// Key-value settings para configuraciones simples
model Setting {
  key   String @id
  value String
}

model EmailEvent {
  id         String   @id @default(cuid())
  campaignId String?
  contactId  String?
  userId     String?
  subject    String?
  toEmail    String
  openedAt   DateTime?
  createdAt  DateTime @default(now())

  campaign Campaign? @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  contact  Contact?  @relation(fields: [contactId], references: [id], onDelete: Cascade)
  user     User?     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([campaignId])
  @@index([contactId])
  @@index([userId])
}

// Plantillas de email reutilizables
model EmailTemplate {
  id          String   @id @default(cuid())
  name        String
  subject     String
  body        String
  category    String?  // ej: "Bienvenida", "Promoción", "Recordatorio"
  variables   Json?    // Variables disponibles como {{nombre}}, {{email}}
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  campaigns     Campaign[]
  automations   Automation[]
  sequences     EmailSequence[]
}

// Secuencias de emails automáticas (drip campaigns)
model EmailSequence {
  id          String   @id @default(cuid())
  name        String
  description String?
  trigger     TrackingEventType
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  steps       EmailSequenceStep[]
  enrollments SequenceEnrollment[]
  templateId  String?
  template    EmailTemplate? @relation(fields: [templateId], references: [id])
}

model EmailSequenceStep {
  id          String   @id @default(cuid())
  sequenceId  String
  order       Int
  delayDays   Int      @default(0)
  delayHours  Int      @default(0)
  subject     String
  body        String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  sequence EmailSequence @relation(fields: [sequenceId], references: [id], onDelete: Cascade)
  sent     SequenceSent[]

  @@index([sequenceId])
}

model SequenceEnrollment {
  id          String   @id @default(cuid())
  sequenceId  String
  contactId   String
  currentStep Int      @default(0)
  completed   Boolean  @default(false)
  enrolledAt  DateTime @default(now())
  completedAt DateTime?

  sequence EmailSequence @relation(fields: [sequenceId], references: [id], onDelete: Cascade)
  contact  Contact       @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@unique([sequenceId, contactId])
  @@index([sequenceId])
  @@index([contactId])
}

model SequenceSent {
  id        String   @id @default(cuid())
  stepId    String
  contactId String
  sentAt    DateTime @default(now())
  openedAt  DateTime?

  step    EmailSequenceStep @relation(fields: [stepId], references: [id], onDelete: Cascade)

  @@index([stepId])
  @@index([contactId])
}

// Mejoras al modelo Campaign para soportar plantillas
model CampaignTemplateLink {
  id          String   @id @default(cuid())
  campaignId  String
  templateId  String

  @@unique([campaignId, templateId])
}
